# Chapter: Installing and Configuring Agents

## Using the Discovery Wizard
Using the wizard is the easiest method to deploy OpsMgr agents. To launch the Discovery Wizard to discover Windows systems, follow these steps:
1.	Open the Operations console and navigate to Administration. Right-click Administration and choose Discovery Wizard (right-clicking any item listed in the left pane provides this option).
2.	On the Discovery Type page, choose Windows computers from the options available (Windows computers, UNIX/Linux computers, and Network devices).
3.	The next page asks you to select either automatic or advanced discovery. Automatic computer discovery scans for all Windows-based computers within the domain where the management server (MS) is a member. Automatic discovery is useful in smaller organizations and very effective when selecting large numbers of systems to which to deploy the OpsMgr agent. For most agent deployments, the preferred option is to take the default of Advanced discovery. The following describes the advanced discovery process:
a.	If you are deploying agents only to servers, take the default option of Servers and Clients from the Computer and Device Classes dropdown list (available options include Servers and Clients, Servers Only, Clients Only, and Network Devices).
b.	TIP : AVOID USING THE SERVERS ONLY OPTION IN THE DISCOVERY WIZARD. It is a best practice to not use the Servers Only option during a discovery as the filter requires contacting each machine for verification. This process slows down the discovery and can lead to discovery failures from timeouts. The Servers Only option is most useful when doing an extremely filtered LDAP query for specific machines versus a large-scale discovery.
c.	If you will be deploying agents onto workstations, take the default configuration (Servers and Clients). Check the option Verify discovered computers can be contacted. This often increases the success rates of the deployment because only systems that can be communicated with over the network are listed for selection.
d.	If you select the Servers Only option, the option Verify discovered computers can be contacted is grayed out and checked. The discovery can return approximately 4,000 computers if the verify option is selected, and approximately 10,000 computers if not selected. Finally, select the management server the agent will communicate with from the drop-down list. Continue by clicking Next.
4.	The Discovery Method page provides two options.
a.	Scan Active Directory to discover computers: The scan option searches Active Directory based on the criteria you specify. Click Configure to choose this option, which opens a Find Computers window you can use to create a custom LDAP query. Examples of this would include searching for all computers (by adding “*” to the Computer name field) or selecting all computers starting with SVR. Additional options for the LDAP query include Description, Managed By, Name, Operating System, Operating System Version, and Phonetic Display Name.
b.	Browse for, or type-in computer names. The Browse for or type-in computer names option includes an additional option: Browse Active Directory for computer information. Selecting the Browse option opens a dialog where you can select computers by searching for computer names (or descriptions) as well as restrict your search to a specific organizational unit. Specify LON-DC1 for installation and click Next to continue.
5. The Administrator Account page allows you to choose the default account or specify another user account when installing the OpsMgr agent. The default is Use Selected Management Server Action Account (also referred to as the MSAA). If your MSAA account is not a domain administrator or at least a local administrator on the target workstation, you can provide credentials for this discovery process. In this case use ADATUM\Administrator. Click Discover to continue.
6. The next page lists the systems available for agent installation (systems that already have the OpsMgr agent are not displayed). Select the appropriate server(s), validate the Management Mode is Agent, and click Next to continue.
You can also use this dialog to install agentless systems, but the focus in this section is on agent-based installations.
7. Take the defaults on the Summary page for the agent installation folder (% ProgramFiles %\System Center Operations Manager\Agent) and for the agent action account to use the credentials of the Local System account.
8. Click Finish to begin installing the OpsMgr agents.
9. The status of each agent deployment displays on the Agent Management Task Status page. The status starts at Queued, changes to Started, and moves to either Success or Failure. Should the agent deployment fail, click the targeted computer; the task output box provides details on why it failed. Click Close when this deployment is complete (deployments continue when the Agent Management Task Status page is closed).

## Approval Process
OpsMgr’s default configuration rejects manually installed agents. Change this configuration in the Administration node of the Operations console by following these steps:
1.	Navigate to Administration -> Settings -> Security. Right-click Security and select Properties.
2.	The General tab shows the default configuration is Reject new manual agent installations. If your environment will use manual agent installation, check the option that says Review new manual agent installations in pending management view.
3.	If you choose the option to review new manual agent installations, a check box is available that reads Automatically approve new manually installed agents. If you select this option, new manual agents are automatically approved. If you do not choose this second option, manually installed agents display in the Operations console, under Administration -> Device Management -> Pending Management, where you can approve or reject their installation.

## Configuring Active Directory Integration
Active Directory Integration creates a container in the domain root of Active Directory named OperationsManager, this is used by clients to determine the management group and management server with which they will communicate.
1. In Active Directory, create a new global security group (e.g. ADIntegration) that contains the computer accounts belonging to the AD Assignment Resource Pool (LON-SV1). To view members of this resource pool, navigate to Administration -> Resource Pools, right-click AD Assignment Resource Pool, and choose View Resource Pool Members (this should contain all management servers in the management group by default).
2. To create the container OpsMgr 2012 uses to store information for AD Integration, open a command prompt and change directory to %ProgramFiles%\Microsoft System Center 2012 R2\Operations Manager\Server.
Run the MOMADAdmin.exe program, passing it this information:
▶ Management group name: determine the management group name by opening the Operations Manager console and looking at the name of the management group, shown on the title of the console.
▶ MOMAdminSecurity group name: ADIntegrationGroup, this is the group created in step 1.
▶ RunAs account name: Specify the account that is used for rules to run on the agent; determine this by navigating in the Operations Manager console to Administration -> Run As Configuration -> Accounts -> Type of Action Account.
▶ Domain in which to create the container.
Example:
MOMADAdmin.exe OMGRP Adatum\ADIntegration Adatum\Administrator Adatum
A successful run of MOMADAdmin indicates it successfully created the container and added the appropriate security group to the container.
3. From the Administration pane, create rules for AD Integration that indicate which servers communicate with a given management server. Configure AD Integration per management server in Administration -> Device Management -> Management Servers by right-clicking a server and choosing Properties.
Click Add to start the Agent Assignment and Failover Wizard, which specifies the domain and defines the inclusion, exclusion, and failover criteria:
▶ Inclusion criteria: On the Inclusion criteria page, define those systems that will report to this management server. LDAP queries can be created based on a naming convention, or an OU or group membership. Use the * wildcard in this exercise.
▶ Exclusion criteria: On the Exclusion page, define any systems that will not report to this management server. This works similarly to the inclusion page; here you can write an LDAP query to exclude systems from reporting to this management server. Leave this step blank.
▶ Failover: On the Failover page, choose a random failover. It’s also possible to specify management servers for failover. When configuring failover, consider that the failover server must be able to support the total number of agents that would report to it should the primary management server fail. As an example, if there are 2,000 servers reporting to a primary server and 2,000 servers reporting to the failover server, if the primary failed the failover server would now be expected to support 4,000 servers, which is beyond the supported number of agents per management server.
4. The group specified when running MOMADAdmin must be added to the Operations Manager Administrator role (Administration -> Security -> User Roles -> Operations Manager Administrators). If this step does not occur, Operations Manager raises an alert indicating that this step is required for AD Integration to function.
5. After configuring AD Integration, you must validate it is functional. There are multiple steps associated with validation, including checking AD, agent event logs, and the registry key on the agent.
NOTE: Since the AD Integration rule that is responsible for the correct configuration runs only once per hour you can skip the following three verification steps, and continue with the PowerShell-based installation. Make sure you perform the following three steps after one hour.
▶ Active Directory: Successful Active Directory Integration creates a container called OperationsManager (to view containers, use View -> Advanced Features in Active Directory Users and Computers). Don’t forget to click Refresh. Within the container there should be another container matching the name of the management group, and within the management group-named folder a HealthServiceSCP folder and a domain local security group. After defining the AD auto assignment information (step 3), a container with the name of the management server and _SCP on the end, and two domain local security groups based on the management server name (with _PrimarySG_# and _SecondarySG_#) are added to the container for the management group.
▶ Agent Event Logs: An agent must be installed without specifying management group information to use Active Directory Integration. When the System Center Management service starts, events are logged in to the Operations Manager event log, indicating AD Integration is configured and that the agent is able to identify its management server.
▶ Registry Key: A registry key is created on the agent indicating AD Integration is configured for the agent. This key is named EnableADIntegration; in OpsMgr 2012 it can be found at HKLM\System\CurrentControlSet\Services\HealthService\Parameters\ConnectorManager. A value of 0 indicates Active Directory Integration is turned off, and a value of 1 indicates that Active Directory Integration is turned on. This value can be changed on an agent, but do not manipulate this registry key on a management server.
