# Chapter: Monitoring with Operations Manager 

## Alert-Generating Rules
The following procedure explains the process to create an alert rule by creating a basic Windows Event Log alert rule. The rule generates an alert if a Operating System crash has been detected. Follow these steps:
1. Open the Operations console and navigate to Authoring -> Management Pack Objects.
2. Right-click Rule and select Create New Rule to initiate the Create Rule Wizard.
3. Select Alert Generating Rules -> Event Based -> NT Event Log (Alert). You must select a destination management pack to store the new rule you are creating. For this example, use Sample Management Pack. (If you need to create the management pack here, select New and enter the name of your new  Management pack.) Click Next to continue.
4. In the General page of the Create Rule Wizard, name the rule and configure a target for the rule. Name this rule Crash detected. Target the Windows Server Operating System class so this rule will apply to all Windows servers. Leave the rule enabled and click Next to continue.
5. On the following page, select the System Event log. You can click the ... button to browse and select the log, or you can simply type in the name of the log. Click Next.
6. At the next page, configure the condition to match for the alert rule. The condition is those items OpsMgr checks against to find the event when it appears in the event log. Use the Build Event Expression page in the wizard to match the Event ID and Event Source parameters. Configure the Event ID as Event ID Equals 6008 and the Event Source to be Event Source Equals EventLog. Click Next to continue.
7. The final page of the Create Rule Wizard configures the actual alert OpsMgr will generate. Leave the alert with the default name. Notice this rule has a Priority of Medium and a Severity level of Critical. Click Create to create the new alert rule.
Confirm that a changed management pack is downloaded by the agent
To confirm whether a changed management pack is downloaded by the agent, you can open the Event Viewer. Connect to LON-DC1. Open the Applications and Services node, click the Operations Manager log and search for event id 1201.
8. In Hyper-V Manager, right click LON-DC1 and click Turn Off. By turning off the server, instead of shutting down, we simulate an Operating System crash. After the DC has been turned off, turn it back on. Open the Operations Manager console on LON-SV1 and wait for the alert to appear.
Repeat the previous procedure with the following parameters: 
Name: Reason for expected shutdown.
Log: System
Source: USER32
Event ID: 1074 
Confirm that the changed management pack is downloaded by the agent (LON-DC1).
Log on to LON-DC1 and click Start -> Shutdown. Enter a reason and click Ok. The reason is logged in the Windows Event Log and picked up by the Operations Manager Agent.
NOTE: CLOSING ALERTS  When you configure an alert using an alert-generating rule, the resulting alert does not close automatically, as is the case with alerts generated by monitors. You must close these alerts manually after resolving the root cause, or they will be auto-resolved after a set amount of time has passed based on your management group settings.

## Creating a Performance Collection Rule
As Windows Performance collection rules are most often used, this section discusses the steps required to gather a performance counter not collected by OpsMgr by default. For this example, you will be collecting the % Processor Time counter for the IIS worker process (w3wp.exe).
1. In the Operations console, navigate to Authoring  Rules.
2. Right-click Rules and select Create New Rule.
3. The Create Rule Wizard displays the Select a Rule Type page. Select Collection Rules -> Performance Based -> Windows Performance as the rule type. Select the Sample Management Pack you previously created as a target for the rule and click Next to continue.
4. On the Rule Name and Description page, name the rule and configure a target for it. For this example, the rule will be called IIS worker process CPU Time. Target the most specific existing class for this example, which is the IIS Server Role class (don’t forget to select the option “view all targets”). Since the rule is targeted to the most specific existing class, it can be enabled so it runs on all IIS servers.
 
5. Next, select the performance counter to collect. While you can type this manually, this is often confusing and time consuming. Use the Select-button to select the Process -> % Processor Time counter for the w3wp process (select instance from list). It should be like the following screenshot.
NOTE: If the w3wp does not appear in the list, start a webbrowser and visit http://localhost. The w3wp process should appear in the list.
 
6. At the Performance Object, Counter, and Instance page, change the collection interval to 1 minute. Click Next to continue to the final page of the wizard.
7. The last page of the wizard allows you to configure optimized collections. OpsMgr uses optimized collections to reduce the amount of disk space a performance counter collection uses in the data warehouse. Click Create to create the performance collection rule.
Confirm that the changed management pack is downloaded by the agent (previous exercise).

## Viewing the results of a collection rule
Open the My Workspace pane. Right click Favorite Views and select New -> Performance View.
Enter the following name: IIS worker process performance. Under Show data related to, click the … button and specify IIS Server Role. Select the checkbox next to “with a specific instance name” and enter the process name: w3wp.
Click Ok. The view should contain the performance counter. Select it to display a graph.  

## Windows Events Monitor
One of the most basic types of monitors is the Windows Events monitor, which detects Windows events and uses these events to update its status. These monitors can vary in complexity from simple, single-event detection to a complex correlation of events; even missing events can contribute to the status of a Windows Events monitor. Follow these steps:
1. Open the Operations console and navigate to Authoring -> Management Pack Objects -> Monitors.
2. To create a new monitor, right-click Monitors in the left pane, then select Create a monitor.
3. Select Unit Monitor to open the Select a Monitor Type page.
4. This monitor will be configured to fail based on a Windows event and return to a normal state based on a different Windows event. From the Select a Monitor Type page, select Windows Events -> Simple Event Detection -> Windows Event Reset. You must also specify the management pack to which you want to add the monitor (as with other examples in this chapter, use the Sample Management Pack). Click Next.
5. Enter a name for the new monitor. This monitor will be called Server Time out of Sync.
Set the target for the monitor to Windows Server Operating System. Set the parent monitor (the monitor under which this one will reside) to Configuration and uncheck the Monitor is Enabled option (it will be enabled later using an override). Click Next.
6. The next few pages of the wizard configure Windows events that alter the state of the monitor, both healthy and unhealthy. On the first page, select the source of the Windows events for the event that will cause the monitor to register an unhealthy state. For this example, set the log to System either by typing the name or choosing ... to select the log. The System log is where the events will appear. Click Next.
7. On the next page, specify the formula by which OpsMgr will match the unhealthy state event.
The Build Event Expression page is where you specify the parameters of the event that enables OpsMgr to accurately detect and update the state to unhealthy when the event appears in the System log. By default, the wizard adds the Event ID and Event Source parameters. In this example, the rule will look for an event with an event ID of 50 and a source of W32Time. This event indicates time synchronization is not working. Once you have specified the event information for the unhealthy event, click next and repeat the process. This will define the event that causes the monitor to return to a healthy state. Use an event from the System log with an Event ID of 37 and a source of W32Time. Event 37 indicates that time synchronization is now working correctly.
8. After you complete these steps and click Next, the Configure Health page displays. Here you can specify the severity of the different states of the monitor. For this example, leave both of these configurations in their default states for warning and healthy. Click Create.
9. In the final page of the wizard, you can specify if the monitor will generate an alert (explained in more detail in the “About Alerts” section). Choose the option to create an alert for this monitor. Once you check the Generate alerts for this monitor check box, a number of options appear:
▶ You can configure the level the monitor must be at before an alert is generated (Warning or Critical). In this case, change the setting to Warning as the health state was defined to be Warning or Healthy. Use the check box below this option to specify whether OpsMgr will Automatically resolve the alert when the monitor returns to a healthy state. You will want to do this in most cases—by enabling monitors to resolve their own alerts, you minimize the number of excess alerts residing in the console at any one time.
▶ Configure the details of the alert in the bottom section of the page; this defines what appears when it is generated. The information includes the name of the alert, any descriptive information, and the priority and the severity of the alert. The alert description field has similar functionality to the event expression builder used in step 7.
10. When satisfied with the alert details and other settings in the wizard, click Create. 
Confirm that the changed management pack is downloaded by the agent. The procedure is explained in a previous exercise.
 
## Basic Service Monitor
As monitoring services is common in OpsMgr, the next procedure creates a Windows service monitor to monitor the Print Spooler service. Follow these steps:
1. In the Operations console, navigate to Authoring -> Management Pack Objects.
2. Right-click Monitors and select Create a Monitor -> Unit Monitor.
3. Select Windows Services -> Basic Service Monitor. Select the Sample Management Pack as a target for the monitor. Click Next to continue.
4. On the next page, name the monitor and configure a target for it. Name this monitor Print Spooler Service Monitor and target the Windows Server Operating System class, as this should apply to all Windows servers. Notice here, unlike when you created rules, you are asked to specify the parent monitor. In this case, leave the setting at the default of Availability. Uncheck the checkbox next to enabled to disabled the monitor. It will be enabled using an override. Click Next to continue.
5. Now, configure the service you want to monitor. In this case, it is the Print Spooler (Spooler) service. You can click the ... button to browse for the service or type Spooler into the service name box. Click Next.
6. The next page of the wizard is the Configure Health page. This is where you define what the health of the monitor will be in relation to the state of the service. Because this is a basic service monitor, it is already correctly defined.
7. The final page of the wizard configures the actual alert OpsMgr will generate. Check the Generate alerts for this monitor check box, leave the alert name as it is, and add an alert description. Also, leave the check box enabled for Automatically resolve alert when.... This means that once the monitor returns to a Healthy state, any generated alerts are automatically resolved. Click Create to create the new service monitor.
Confirm that the changed management pack is downloaded by the agent. The procedure is explained in a previous exercise.
 
## Creating an Override
This section looks at the process for creating an override against a monitor. Here are the steps to create an override from the Authoring pane in Operations Manager. Overrides can also be created in the Monitoring or My Workspace panes.
1. Navigate in the Operations console to Authoring -> Monitors.
2. Using one of the search methods discussed in the “Locating Rules and Monitors in the Operations Console” section, locate the monitor you wish to override. This example will override the Available Megabytes of Memory monitor located under the Windows Server 2016 Operating System class. Using the scoping bar, scope the console to this class. You will find this monitor under the Performance aggregate monitor.
3. After locating the monitor, right-click and select Overrides. Next, choose Override the Monitor. Notice there is also the option to Disable the Monitor, which is a simple way to disable the monitor for an object, class, or group without going through the steps listed in this section. In OpsMgr 2007 using the disable option was not recommended, as disabling stored the override in the Default management pack. This is no longer the case in Operations Manager 2012. The Disable the Monitor option creates an override that sets the Enabled flag to False and stores it in the management pack that you specify.
Choosing Override the Monitor opens a submenu with the following options:
▶ For all objects of class: < Class the monitor is attached to >
▶ For a group...
▶ For a specific object of class: < Class the monitor is attached to >
▶ For all objects of another class.....
4. For this example, assume a single computer running Windows Server 2016 is causing excessive alerts. For this override, choose specific object of class Windows Server 2016 Operating System. Selecting this option presents the Select Object dialog. From this page, select the server (in this case LON-SV1) for the computer that is experiencing heavy usage and therefore generating alerts.
5. Highlight the object and click OK after selecting the object you wish to override. The Override Properties page displays.
6. The Override Properties page displays all the parameters you can override for the monitor. This particular monitor includes a large number of parameters you can override. Because the interest is to modify the threshold values, focus on the Available Memory Threshold (Mbytes) parameter.
To modify this parameter, scroll down to tick the check box next to the parameter and type the new value in the Override Value column, which should highlight automatically when you put a tick in the check box. For this example, change the value to 50MB. Type 50 into the column, select the management pack in which to store the override, and click Apply. The next column (Effective Value) will change to reflect the change you made. Click OK to close the dialog box.
7. To verify the override, look in the Overrides Summary page. To locate this page, right-click the monitor, and choose Overrides Summary. You will see the override listed in the Overrides Summary page. From here, you can delete or edit any overrides as required.
Confirm that the changed management pack is downloaded by the agent. The procedure is explained in a previous exercise.

## Other overrides
Overrides are often used to change threshold values. Other examples of the use of overrides is enabling or disabling a certain rule or monitor for a class, group or specific object. For example: you can enable a disabled monitor (previously created) for a specific group of servers.
Repeat the previous procedure (Creating an override) with the following parameters:
•	Monitor name: Print Spooler Service Monitor
•	Override the Monitor: for a group: Windows Server 2016 Computers
•	Enabled: true
Repeat the previous procedure (Creating an override) with the following parameters:
•	Monitor name: Server Time out of Sync
•	Override the Monitor: for a group: Windows Server 2016 Computers
•	Enabled: true

## Locate overrides
Try these three methods when locating overrides:
•	Operations console  Authoring  Management Pack Objects -> Overrides.
•	Operations console  Reporting  Microsoft Generic Report Library -> Overrides.
•	PowerShell  Get-SCOMOverride. More information on the Operations Manager Shell can be found in Chapter 23, “PowerShell and Operations Manager.”
